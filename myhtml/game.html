<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>PsyChoProj: Play</title>
    </head>

<body>
        <!--登陸層-->
        <div id="loginDiv" class="dlbj">
        <!--127.0.0.1 is localhost -->
                <p>Username</p>
                <div><input id="tUser" type="text" name="textfield"></div>
                <div class="dlfwq" id="btnCon"><img src="http://www.gifs.cc/enter/enter-with-frame.png"  border="0"></div>
        </div>
        <div id="main" class="main" style="display:none">
                This is where you put background.
                <div id="roominfo"></div>
                <div id ="gameinfo" style="display:none">
                    <div>Round <span id="round"></span></div>
                    <div>Time remains <span id ="gametime"></span> seconds...</div>
                    <div id ="god">
                        God give you <span id="roomMon" ></span> dollars this round.
                    </div>
                    <div id ="other">
                        The other give you <span id ="othermon">0</span> dollars last round.
                    </div>
                    
                    <div>You have <span id="money">0</span> dollars before this round.</div>
                </div>
                
                <div id="p1dec">
                <br>
                        Player one : How much you want to give to P2 ?
                        <div><input id="p1m" type="text" name="textfield"></div>
                        <button id="btnCon1" type="button">Submit</button>
                </div>
                
                <div id="p2dec">
                <br>
                        
                        Player two : How much you want to give to P1 ?
                        <div><input id="p2m" type="text" name="textfield"></div>
                        <button id="btnCon2" type="button">Submit</button>
                </div>
        </div>
        <div id ="final" style="display:none">
            You got <div id = "level"></div> level 
        </div>
</body>

        <script src="/socket.io/socket.io.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<script>
(function(){

    var Client = {
 
        so:null,
        isFirstConnect:true,
        myturn:false,
        user:{"uname":null},
    };

    Client.connect = function(host,port){
         var p = port||80,
                 self = this;
         if(this.so==null)
         {
                 this.so = io.connect("http://"+host+":"+p,{'reconnect':false});
                 if(this.so)
                 {            
                     this.so.on("connect",function(){self.doConnect();});      
                     this.so.on("error",function(data){this.so = null ; alert("Connection failed!");});
                 }
         }
         else
         {
                 this.so.socket.reconnect();
         }
    };
 
    Client.login = function(callback)
    {
 
            this.so.emit("login",{"uname":this.user.uname},function(data,playnum,totalround){
                 callback(data,playnum,totalround);
            });
    };

    Client.doConnect = function()
    {   
        
         if(this.isFirstConnect)
         {
                this.isFirstConnect = false;
                this.bindEvent();
         }
         else
         {
                this.so.socket.reconnect();
         }
    };

    Client.bindEvent = function()
    {
         var self = this;
         //this.so.on("message",function(msg){self.doMessage(msg);});
         this.so.on("sendMessage",function(data){self.showMessage(data);});
         this.so.on('gameready',function(data){self.showStat(data);});
         this.so.on('sendturn',function(data){self.showTurn(data);});
         this.so.on('sendMoney',function(data){self.showMoney(data);});
         this.so.on('sendtime',function(data){self.showTime(data);});
         this.so.on('endgame',function(data){self.doEnd(data);});
    };
    Client.showMessage = function(data)
    {
        alert(data.mes);
    };
    
    Client.showStat = function(data)
    {
        if (data.ready===true)
        {
            $("#gameinfo").show();
                $("#roominfo").text("Room is "+data.room);
        }
        else
        {
                $("#roominfo").text("Waiting for other player...");
        }
    };
    Client.showTurn = function(data)
    {
        if (data.turn===true)
        {
            $("#god").show();
            $("#other").show();

            if (data.ptype===1)
                $("#p1dec").show();
            else if (data.ptype===2)
                $("#p2dec").show();
            else
                alert("Bug occurs, contact the author");
        }
        else
        {
            $("#god").hide();
            $("#other").hide();
            $("#p1dec").hide();
            $("#p2dec").hide();
        }
        $("#round").text(data.nowround+1);
        $("#roomMon").text(data.roommon);
        $("#othermon").text(data.othermon);
    };
    Client.showMoney = function(data)
    {
        $("#money").text(data.mon);
    };
    Client.showTime = function(data)
    {
        $("#gametime").text(data.nowtime);
    };
    Client.sendDecval = function(value)
    {
        this.so.emit("clitoser",{'val':value});
    };
    Client.doEnd = function(data)
    {
        var prefix = "http://localhost:8888/ending";
        //IP
        if(data.level === "loser")
            window.location.href = prefix+"loser";
        else if(data.level === "smart")
            window.location.href = prefix+"smart";
        else
            window.location.href = prefix+"winner";
    };
    window.Client = Client;
}())

function isSupportHTML5()
{
        return (typeof(Worker) !=="undefined");
}
function isInt(value) 
{
  var x;
  if (isNaN(value)) {
    return false;
  }
  x = parseFloat(value);
  return (x | 0) === x;
}
$(document).ready(function(){
    if(!isSupportHTML5())
    {
            alert("Your browser does not support HTML5!");
    }
    else
    {
        //sending login message
        $("#btnCon").click(function(){
            //need to modify to my own host
            //var host = $("#host").val(),
            //var host = '140.112.249.166',
            var host = '127.0.0.1',
            user = $("#tUser").val();
            Client.connect(host,8888);
            Client.user.uname = user ; 
            Client.login(function(data,playnum,totalround){
                    if(data==1)
                    {
                        alert("This user already exist, please change user!");
                    }
                    else
                    {
                        var cliround = 1;
                        //this.playnum = playnum;
                        $("#loginDiv").hide();
                        $("#main").show();
                        $("#p1dec").hide();
                        $("#p2dec").hide();
                        //sending decision money
                        $("#btnCon1").click(function(){
                                //console.log("OK");
                                var value = $("#p1m").val();
                                if(!isInt(value) )
                                    alert("Invalid value! Enter a integer!")
                                else if (value<0 || value > parseInt($("#roomMon").text()) )
                                    alert("Value shoud be in range [0,"+parseInt($("#roomMon").text())+"]")
                                else
                                    Client.sendDecval(value);
                        });
                        $("#btnCon2").click(function(){
                                //console.log("OK");
                                var value = $("#p2m").val();
                                if(!isInt(value) )
                                    alert("Invalid value! Enter a integer!")
                                else if (value<0 || value > parseInt($("#roomMon").text()) )
                                    alert("Value shoud be in range [0,"+parseInt($("#roomMon").text())+"]")
                                else
                                    Client.sendDecval(value);
                        });
                    }
            });

                    
        });

            
    }
})
</script>
</html>
