<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>PsyChoProj: Play</title>
    </head>

<style>
  body{
        margin:0;
        padding:0; 
        background:url(http://imgur.com/vmbSMdq.jpg);
        background-repeat:no-repeat;
        background-attachment:fixed;
        background-size:100%;
        background-size: cover;
        background-location:bottom; 
        color:black;
    }
  #x{
      width:90%;margin: 0px auto;
      text-align:center;position: relative;top:10%;
    }
</style>

<body>

    <div id="preload" style="visibility: hidden;display: none">
        <img src="http://imgur.com/FCG3g0l.jpg" width="0" height="0" alt="Image 01" />
        <img src="http://imgur.com/YW5qiJq.png" width="0" height="0" alt="Image 02" />
        <img src="http://imgur.com/jlzqCY2.jpg" width="0" height="0" alt="Image 03" />
    </div>

        <!--登陸層-->
        <div id="loginDiv" class="dlbj">
            <div style="position:fixed;width:40%;height:20%;left:30%;top:40%;text-align:center;font-size:2vh;font-color:black;font-family:fantasy,Microsoft JhengHei">
                        <p>暱稱:<input id="tUser" type="text" name="textfield"></p>
                        <p>性別:<input value="man" type="radio" name="gen">男<input value="woman" type="radio" name="gen">女</p>
                        <p>系所:<input id="dep" type="text" name="textfield"></p>
						<p>年級:<input value="fresh" type="radio" name="age">一 
						        <input value="suffer" type="radio" name="age">二 
								<input value="junior" type="radio" name="age">三 
								<input value="senior" type="radio" name="age">四 </p>
                        <div class="dlfwq" id="btnCon"><img src="http://www.gifs.cc/enter/enter-with-frame.png"  border="0" width=20%></div>
            </div>
        </div>



        <div id="main" class="main" style="display:none;font-family:fantasy,Microsoft JhengHei">
            <img src="http://imgur.com/K3rbIpA.png" id="image1" style="position:fixed;display:none;z-index:-1" width=30%/>
            <img src="http://imgur.com/agjHyr9.png" id="image2" style="position:fixed;display:none;z-index:-1" width=15%/>
            <img src="http://imgur.com/GNYvhTK.jpg" id="image" style="position:fixed;display:none;z-index:-1" width=10%/>
            <img src="http://imgur.com/eDBHMge.png" id="goddd" style="position:fixed;display:none;z-index:-1" width=20%/>

            <img src="http://imgur.com/OeV2ObD.png" id="say1" style="position:fixed;display:none;right:5%;top:10%;z-index:-1" width=40%/>
            <img src="http://imgur.com/uDjnQ9B.png" id="say2" style="position:fixed;display:none;right:5%;top:10%;z-index:-1" width=40%/>
            <img src="http://imgur.com/6lPHkxl.png" id="say3" style="position:fixed;display:none;right:5%;top:10%;z-index:-1" width=40%/>
            <img src="http://imgur.com/vo4XCDl.png" id="say4" style="position:fixed;display:none;right:5%;top:10%;z-index:-1" width=40%/>

                <div id="roominfo">
                    <div style="position:fixed;width:40%;height:20%;left:30%;top:40%;text-align:center">
                        <img src="http://imgur.com/xrf0x3D.png"  border="0" width=50%>
                    </div>
                </div>

                <div id="player" style="display:none;background-repeat:no-repeat;background-image:url(http://imgur.com/jlzqCY2.jpg);background-size:100%;position:fixed;width:16%;height:5%;left:4%;bottom:5%;text-align:center;z-index:-2;font-size:5vh;color:black">
                    <b><span id="userid"></span></b>
                </div>
                <div id="opponent" style="display:none;background-repeat:no-repeat;background-image:url(http://imgur.com/jlzqCY2.jpg);background-size:100%;position:fixed;width:16%;height:5%;right:4%;bottom:5%;text-align:center;z-index:-2;font-size:5vh;color:black">
                    <b><span id="enemy"></span></b>
                </div>

                <div id="gameinfo" style="display:none">


                    <div style="background-repeat:no-repeat;background-image:url(http://imgur.com/YW5qiJq.png);background-size:100%;position:fixed;width:34%;height:60%;left:0%;top:0%;text-align:center;z-index:-2">
                        <div style="font-size:3vh"><br><br><br><br><br></div>
                        <div style="font-size:6vh;font-color:black">
                                <b>你現在有<img src="http://imgur.com/TEw3bRS.jpg" width=18%>:<span id="money">0</span></b>
                        </div>
                        <div style="font-size:3vh;font-color:black">
                            <b><div>第 <span id="round"></span> 回合-倒數計時: <span id ="gametime"></span> 秒...</div>
                            <div id ="god">
                                因為很開心，上天這次降下 <span id="roomMon" ></span> 圓
                            </div>
                            <div id ="other">
                                上一回合，您的朋友給您 <span id ="othermon">0</span> 圓
                            </div>
                            <div id ="chat">
                                這是別人的回合喔~<br>喘口氣稍等一下!
                            </div></b>
                        </div>
                    </div>
                </div>
                
                <div id="p1dec">
                        <div style="position:fixed;width:40%;height:30%;left:30%;bottom:10%;text-align:center">
                            <div style="z-index:-1"><img src="http://imgur.com/ISSJVJ0.png"  border="0" width=50%></div>
                            <div style="z-index:0">
                                <div><input id="p1m" type="text" name="textfield"></div>
                                <div id="btnCon1" type="button"><img src="http://imgur.com/MRFgf5V.png"  border="0" width=30%></div>
                            </div>
                        </div>

                </div>
                
                <div id="p2dec">
                        <div style="position:fixed;width:40%;height:30%;left:30%;bottom:10%;text-align:center">
                            <div style="z-index:-1"><img src="http://imgur.com/ISSJVJ0.png"  border="0" width=50%></div>
                            <div style="z-index:0">
                                <div><input id="p2m" type="text" name="textfield"></div>
                                <div id="btnCon2" type="button"><img src="http://imgur.com/MRFgf5V.png"  border="0" width=30%></div>
                            </div>
                        </div>
                </div>
        </div>
        <div id ="final" style="display:none">
            You got <div id = "level"></div> level 
        </div>
      


</body>

        <script src="/socket.io/socket.io.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<script>
(function(){

    var Client = {
 
        so:null,
        isFirstConnect:true,
        myturn:false,
        user:{"uname":null,"ugen":null,"udep":null,"uage":null},
    };

    Client.connect = function(host,port){
         var p = port||80,
                 self = this;
         if(this.so==null)
         {
                 this.so = io.connect("http://"+host+":"+p,{'reconnect':false});
                 if(this.so)
                 {            
                     this.so.on("connect",function(){self.doConnect();});      
                     this.so.on("error",function(data){this.so = null ; alert("Connection failed!");});
                 }
         }
         else
         {
                 this.so.socket.reconnect();
         }
    };
 
    Client.login = function(callback)
    {
        //MODDDDDD user:{"uname":null,"ugen":0,"udep":null,"uage":0},
            this.so.emit("login",{"uname":this.user.uname,"ugen":this.user.ugen,"udep":this.user.udep,"uage":this.user.uage},
                function(data,playnum){
                 callback(data,playnum);
            });
    };

    Client.doConnect = function()
    {   
        
         if(this.isFirstConnect)
         {
                this.isFirstConnect = false;
                this.bindEvent();
         }
         else
         {
                this.so.socket.reconnect();
         }
    };

    Client.bindEvent = function()
    {
         var self = this;
         //this.so.on("message",function(msg){self.doMessage(msg);});
         this.so.on("sendMessage",function(data){self.showMessage(data);});
         this.so.on('gameready',function(data){self.showStat(data);});
         this.so.on('sendturn',function(data){self.showTurn(data);});
         this.so.on('sendMoney',function(data){self.showMoney(data);});
         this.so.on('sendtime',function(data){self.showTime(data);});
         this.so.on('endgame',function(data){self.doEnd(data);});
    };
    Client.showMessage = function(data)
    {
        alert(data.mes);
        window.location.reload(true);

    };
    
    Client.showStat = function(data)
    {
        if (data.ready===true)
        {
            $("#roominfo").hide();
            $("#gameinfo").show();
            $("#roominfo").text("Room is "+data.room);
            $("#enemy").text(data.oppo);
            $("#player").show();
            $("#opponent").show();
        }
        else
        {
                $("#roominfo").show();
        }
    };
    Client.showTurn = function(data)
    {
        if (data.turn===true)
        {
            $("#god").show();
            $("#other").show();
            $("#chat").hide();
        }
        else
        {
            $("#god").hide();
            $("#other").hide();
            $("#chat").show();
            $("#p1dec").hide();
            $("#p2dec").hide();
        }
        
        $("#round").text(data.nowround+1);
        $("#roomMon").text(data.roommon);
        $("#othermon").text(data.othermon);

function getScreenSize(target){
    var theWidth;
    var theHeight;
    if(target.innerWidth){ 
        theWidth=target.innerWidth;
        theHeight=target.innerHeight;
    }
    else if(target.document.compatMode=='CSS1Compat'){
        theWidth=target.document.documentElement.clientWidth;
        theHeight=target.document.documentElement.clientHeight;
    }
    else if(target.document.body){
        theWidth=target.document.body.clientWidth;
        theHeight=target.document.body.clientHeight;
    } 
    var result={width:theWidth, height:theHeight};
    return result;
}

var pic=document.getElementById("image");

var screenHeight=getScreenSize(window).height;
var screenWidth=getScreenSize(window).width;

document.getElementById("image1").style.bottom=screenHeight/10;
document.getElementById("image2").style.bottom=screenHeight/10;
document.getElementById("image2").style.right=0;
document.getElementById("goddd").style.right=screenWidth*0.4;

var picWidth=screenWidth/10;
var picHeight=picWidth/1.75;

function vertical(t,b,c1){
    return c1*(t/500 + (1-Math.abs(Math.sin(t/30)))/20) + b*c1;
}

function horizontal(t,c2,turn){
    return turn*c2*(Math.sin(t/30));
}

function drop(){
    var t=0;
    var b=0.3;
    var c1=screenHeight - picHeight;
    var c2=(screenWidth - picWidth)/5;
    var dollar=0;
    var turn=-1;
    if(data.turn===true)turn=1;
    
    $("#image1").show();
    $("#image2").show();
    $("#goddd").show();
    if(data.nowround>0)$("#say"+(data.nowround)).hide();
    $("#say"+(data.nowround+1)).show();

    function run(){
        if(t===0){
            $("#image").show(function(){
                t++;
                setTimeout(run, 10);
            })
        }
        else{
            pic.style.top=Math.ceil(vertical(t,b,c1)) + "px";
            pic.style.left=Math.ceil(horizontal(t,c2,turn) + (screenWidth - picWidth)/2) + "px";
        
            if(Math.ceil(vertical(t,b,c1))<c1){ 
                t++;
                setTimeout(run, 10);
            }
            else if(data.turn===true){
                if(data.ptype===1){$("#p1dec").fadeIn("slow");}
                else if(data.ptype===2){$("#p2dec").fadeIn("slow");}
                else {alert("Bug occurs, contact the author");}
            }
        }
    }
    run();
};
drop();


    };
    Client.showMoney = function(data)
    {
        $("#money").text(data.mon);
    };
    Client.showTime = function(data)
    {
        $("#gametime").text(data.nowtime);
    };
    Client.sendDecval = function(value)
    {
        this.so.emit("clitoser",{'val':value});
    };
    Client.doEnd = function(data)
    {
        //IIPP
        //var prefix = "http://localhost:8888/ending";
		var prefix = "http://140.112.249.166:8888/ending";
        //var prefix = "http://127.0.0.1:8888/ending";
        //IP
        if(data.level === "loser")
            window.location.href = prefix+"loser";
        else if(data.level === "smart")
            window.location.href = prefix+"smart";
        else
            window.location.href = prefix+"winner";
    };
    window.Client = Client;
}())

function isSupportHTML5()
{
        return (typeof(Worker) !=="undefined");
}
function isInt(value) 
{
  var x;
  if (isNaN(value)) {
    return false;
  }
  x = parseFloat(value);
  return (x | 0) === x;
}
$(document).ready(function(){
    if(!isSupportHTML5())
    {
            alert("Your browser does not support HTML5!");
    }
    else
    {
        //sending login message
        $("#btnCon").click(function(){
            //IIPP
            var host = '140.112.249.166',
            //var host = '127.0.0.1',
            user = $("#tUser").val();
			user_dep = $("#dep").val();
			user_gen = $('input[name="gen"]:checked').val();
			user_age = $('input[name="age"]:checked').val();
			
			//MODDDDDD user:{"uname":null,"ugen":0,"udep":null,"uage":0},
            $("#userid").text(user);

            Client.connect(host,8888);
            Client.user.uname = user ;
			Client.user.ugen = user_gen;
			Client.user.uage = user_age;
			Client.user.udep = user_dep;
			
			
            Client.login(function(data,playnum){
                    if(data==1)
                    {
                        alert("This user already exist, please change user!");
                    }
                    else
                    {
                        //var cliround = 1;
                        //this.playnum = playnum;
                        
                        $("#loginDiv").hide();
                        

                        $("#main").show(function(){
                            $("body").css("background-image","url('http://imgur.com/FCG3g0l.jpg')");
                        });




                        $("#p1dec").hide();
                        $("#p2dec").hide();
                        //sending decision money
                        $("#btnCon1").click(function(){
                                //console.log("OK");
                                var value = $("#p1m").val();
                                if(!isInt(value) )
                                    alert("Invalid value! Enter a integer!")
                                else if (value<0 || value > parseInt($("#roomMon").text()) )
                                    alert("Value shoud be in range [0,"+parseInt($("#roomMon").text())+"]")
                                else
                                    Client.sendDecval(value);
                        });
                        $("#btnCon2").click(function(){
                                //console.log("OK");
                                var value = $("#p2m").val();
                                if(!isInt(value) )
                                    alert("Invalid value! Enter a integer!")
                                else if (value<0 || value > parseInt($("#roomMon").text()) )
                                    alert("Value shoud be in range [0,"+parseInt($("#roomMon").text())+"]")
                                else
                                    Client.sendDecval(value);
                        });
                    }
            });

                    
        });

            
    }
})
</script>
</html>
